version: '3.8'

services:
  # MetaFlow application
  metaflow:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: metaflow:latest
    container_name: metaflow-app
    environment:
      version: '3.8'

      services:
        # MetaFlow application
        metaflow:
          build:
            context: ..
            dockerfile: docker/Dockerfile
          image: metaflow:latest
          container_name: metaflow-app
          environment:
            - SPARK_MASTER=local[*]
            - METAFLOW_ENV=production
            - PYTHONPATH=/app
          volumes:
            - ../examples:/app/examples
            - metaflow-data:/data
            - metaflow-logs:/logs
            - metaflow-checkpoints:/checkpoints
          ports:
            - "4040:4040"  # Spark UI
            - "8080:8080"  # Application UI
          networks:
            - metaflow-network
          depends_on:
            postgres:
              condition: service_healthy
          command: ["tail", "-f", "/dev/null"]  # Keep container running

        # PostgreSQL - Source database
        postgres:
          image: postgres:15-alpine
          container_name: metaflow-postgres
          environment:
            POSTGRES_DB: sourcedb
            POSTGRES_USER: metaflow
            POSTGRES_PASSWORD: metaflow123
            POSTGRES_INITDB_ARGS: "-E UTF8"
          volumes:
            - postgres-data:/var/lib/postgresql/data
            - ./init-scripts/postgres:/docker-entrypoint-initdb.d
          ports:
            - "5432:5432"
          networks:
            - metaflow-network
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -U metaflow"]
            interval: 10s
            timeout: 5s
            retries: 5

        # MySQL - Alternative source database
        mysql:
          image: mysql:8.0
          container_name: metaflow-mysql
          environment:
            MYSQL_ROOT_PASSWORD: rootpass
            MYSQL_DATABASE: sourcedb
            MYSQL_USER: metaflow
            MYSQL_PASSWORD: metaflow123
          volumes:
            - mysql-data:/var/lib/mysql
            - ./init-scripts/mysql:/docker-entrypoint-initdb.d
          ports:
            - "3306:3306"
          networks:
            - metaflow-network
          healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 10s
            timeout: 5s
            retries: 5

        # Kafka - For streaming pipelines
        kafka:
          image: confluentinc/cp-kafka:7.5.0
          container_name: metaflow-kafka
          depends_on:
            - zookeeper
          environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
          ports:
            - "9092:9092"
          networks:
            - metaflow-network
          healthcheck:
            test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
            interval: 10s
            timeout: 10s
            retries: 5

        # Zookeeper - For Kafka
        zookeeper:
          image: confluentinc/cp-zookeeper:7.5.0
          container_name: metaflow-zookeeper
          environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
          ports:
            - "2181:2181"
          networks:
            - metaflow-network
          healthcheck:
            test: ["CMD-SHELL", "(echo >/dev/tcp/localhost/2181) >/dev/null 2>&1 || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 6

        # Kafka UI - For monitoring
        kafka-ui:
          image: provectuslabs/kafka-ui:latest
          container_name: metaflow-kafka-ui
          depends_on:
            - kafka
          environment:
            KAFKA_CLUSTERS_0_NAME: local
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
          ports:
            - "8090:8080"
          networks:
            - metaflow-network
          healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 5

        # MinIO - S3-compatible storage for Delta Lake
        minio:
          image: minio/minio:latest
          container_name: metaflow-minio
          environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
          volumes:
            - minio-data:/data
          ports:
            - "9000:9000"
            - "9001:9001"
          networks:
            - metaflow-network
          command: server /data --console-address ":9001"
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

        # Adminer - Database management UI
        adminer:
          image: adminer:latest
          container_name: metaflow-adminer
          ports:
            - "8081:8080"
          networks:
            - metaflow-network
          depends_on:
            - postgres
            - mysql
          healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 3

        # Prometheus - Metrics collection
        prometheus:
          image: prom/prometheus:latest
          container_name: metaflow-prometheus
          volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus-data:/prometheus
          ports:
            - "9090:9090"
          networks:
            - metaflow-network
          command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
          healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:9090/metrics || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 5

        # Grafana - Metrics visualization
        grafana:
          image: grafana/grafana:latest
          container_name: metaflow-grafana
          environment:
            GF_SECURITY_ADMIN_USER: admin
            GF_SECURITY_ADMIN_PASSWORD: admin
            GF_INSTALL_PLUGINS: grafana-piechart-panel
          volumes:
            - grafana-data:/var/lib/grafana
            - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
            - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
          ports:
            - "3000:3000"
          networks:
            - metaflow-network
          depends_on:
            prometheus:
              condition: service_healthy
          healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
            interval: 15s
            timeout: 5s
            retries: 6

      volumes:
        metaflow-data:
        metaflow-logs:
        metaflow-checkpoints:
        postgres-data:
        mysql-data:
        minio-data:
        prometheus-data:
        grafana-data:

      networks:
        metaflow-network:
          driver: bridge